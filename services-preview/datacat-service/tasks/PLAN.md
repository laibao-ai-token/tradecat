# Datacat Service 重构计划（严格分层 | 全量细化版）

## 1. 目标

- 在**不改动原服务** `services/data-service` 的前提下，完成采集能力复制/复用/拆分。
- 迁移到严格分层目录结构，形成长期可演进采集基建。

## 2. 硬性约束

- **禁止**修改原服务任何文件。
- **仅**在 `services-preview/datacat-service` 内新增/调整内容。
- 严格遵循分层顺序：
  `source → market → scope → mode → direction → channel → type → granularity → impl`
- 所有采集实现必须放在 `collector.py`（不新增其他 Python 模块文件）。

## 3. 基线说明

- 原服务目录：`services/data-service`
- 原服务职责：Binance USDT 永续（WS K线 + REST 指标 + 回填）
- 新服务目录：`services-preview/datacat-service`
- 新服务状态：已建全深度目录骨架 + 文档模板 + tasks 目录

## 4. 迁移策略（不动原服务）

1) 方法清点 → 2) 路径映射 → 3) 复制/复用落地 → 4) 依赖内聚 → 5) 一致性校验

说明：
- 允许“先复用后内聚”的两阶段策略。
- 任意复用必须保证原服务逻辑不变、运行不受影响。

## 5. 任务分级原则（强制）

- 主任务编号：01–11（按阶段）
- 子任务编号：01-01 / 01-02 / …（细粒度可执行项）
- 每个子任务必须有：输入、输出、执行步骤、验收标准

## 6. 计划阶段（依赖顺序）

- 阶段 A：清点与映射（任务 01）
- 阶段 B：WS K线迁移（任务 02，依赖任务 01）
- 阶段 C：REST Metrics 迁移（任务 03，依赖任务 01）
- 阶段 D：回填与文件下载迁移（任务 04，依赖任务 01）
- 阶段 E：配置与入口对齐（任务 05，依赖任务 07/08）
- 阶段 F：一致性校验执行（任务 06，依赖任务 11）
- 阶段 G：配置矩阵与默认值对齐（任务 07）
- 阶段 H：运行模型与入口复制（任务 08）
- 阶段 I：依赖与路径隔离（任务 09）
- 阶段 J：符号体系与 Alpha 规则（任务 10）
- 阶段 K：验收指标与对照样本定义（任务 11）

## 7. 交付物（必须存在）

- 映射表（原路径 → 新路径）
- 严格分层下的 collector.py 复用/复制实现
- 配置矩阵与运行入口说明
- 对照验收报告（日志/行数/字段）

## 8. 主要风险与对策

- 复用逻辑导致路径/日志冲突 → 任务 09
- WS 依赖回填逻辑断链 → 任务 04
- 入口不兼容 → 任务 08

## 9. 验收标准

- 原服务未修改且可运行。
- 新服务严格分层目录下具备等价采集能力。
- 对照误差 ≤ 1%，日志关键字段一致。
