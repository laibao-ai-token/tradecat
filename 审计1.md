# 全面代码与安全审计报告

## 1. 摘要 (Executive Summary)
- 审计输入来源：本地代码 + 变更说明《改动1.md》，未提供方向变量。
- 规范审查结论：⚠️ 无法裁决方向合规性（未提供方向变量）。
- 总体安全风险：高 — 多个公开接口缺乏鉴权，且存在 SQL 注入与宽松 CORS。
- 风险计分卡：Critical 0 | High 3 | Medium 2 | Low 1
- 关键发现 Top 5：
  1) 全量 API 无鉴权暴露生产数据。  
  2) CORS 允许任意来源且 allow_credentials=True。  
  3) /indicator/data 以字符串拼接表名，存在 SQL 注入。  
  4) futures/open-interest & funding-rate/metrics 忽略 interval/exchange 参数，语义偏差。  
  5) 变更文档声明端口 8089，代码默认 8088，易部署失配。
- 需要立即确认/回滚：若 API 面向公网，需立刻加鉴权并修复 CORS 与 SQL 注入。

## 2. 审计范围、假设与方向变量
### 2.1 审计范围与假设
- 范围：`services-preview/api-service` 全部源文件、启动脚本、文档；`services/telegram-service/requirements.txt` psutil 增补。
- 假设：API 将在可访问 TimescaleDB/SQLite 的环境运行；无外层网关/鉴权（未见相关代码）；未提供部署网络与角色定义。
- 不确定性影响：缺少真实部署拓扑与上游网关策略，无法判断外层是否已有访问控制；缺少 DB 权限模型，SQL 注入影响范围需保守为“读全库”。

### 2.2 方向变量与对齐总览
- 未提供方向变量 → 无法判定通过/失败，仅输出客观偏差与风险。

## 3. 变更解析与威胁建模
- 变更点：新增 api-service（多路由）；psutil 依赖补充。
- 攻击面新增：HTTP 端口（默认 8088，文档宣称 8089）开放；直连 TimescaleDB、SQLite；新增 CORS 暴露。
- 权限模型变化：所有新端点默认匿名可读数据库。
- 数据流变化：外部 → FastAPI → TimescaleDB/SQLite → 响应，无中间鉴权/速率限制。

## 4. 详细审计发现 (按 12 大类，严重度高→低)

### 1) 控制流
- **F4 参数被忽略导致语义分裂**  
  - 规范严重级别：S2｜安全严重级别：Medium｜置信度：中  
  - 位置：`routers/open_interest.py:20-52`, `routers/funding_rate.py:20-52`, `routers/futures_metrics.py:20-42`  
  - 证据：interval/exchange 参数验证后未进入 SQL，始终查询 `binance_futures_metrics_5m`。  
  - 对齐分析：用户传递 interval/exchange 不影响结果，产生“多世界”输出，不符合“唯一执行语义”。  
  - 安全分析：可被用于混淆监控或绕过数据校验，但不直接泄露敏感数据。  
  - 修复建议：将 interval/exchange 映射到相应表/过滤条件，或删除无效参数并文档声明。  
  - 验证：单测覆盖 interval=30m、exchange=OKX 期望命中不同数据源；比对响应变化。  
  - 标准映射：CWE-440（意外的行为分歧）  
  - 追问：是否存在多周期/多交易所表？命名规则？

### 2) 执行模型
- **无显著发现**

### 3) 状态
- **无显著发现**

### 4) 时间与顺序
- **无显著发现**

### 5) 错误与失败
- **F5 资源释放缺失可能导致连接泄漏**  
  - 规范严重级别：S1｜安全严重级别：Medium｜置信度：中  
  - 位置：多处 `psycopg.connect` / `sqlite3.connect` 后在异常路径无 finally 关闭（如 `ohlc.py:32-76`, `coins.py:23-37` 等）。  
  - 偏离：异常时连接不闭合，导致资源耗尽分支。  
  - 安全：高并发下可能引发 DoS（连接耗尽）。  
  - 修复：使用 `with psycopg.connect(...) as conn:` / `with conn:` 上下文管理；或在 finally 关闭。  
  - 验证：压测并触发异常（无效表/断网），监控连接数与进程 FD。

### 6) 输入与前置条件
- **F3 /indicator/data 存在 SQL 注入**  
  - 规范严重级别：S3｜安全严重级别：High｜置信度：高  
  - 位置：`routers/indicator.py:55-79`，`query = f'SELECT * FROM "{table}"'`；`LIMIT` 同样字符串拼接。  
  - 偏离：表名直接由用户输入拼接，破坏唯一语义。  
  - 攻击路径：构造表名 `foo" UNION SELECT name,password FROM sqlite_master--` 读取系统表；或使用 `";ATTACH DATABASE '/etc/passwd' AS x;` 读取文件。  
  - 修复（规范层）：对白名单表名（来自 list 结果）做匹配，或使用参数化/`execute(f'SELECT * FROM {quote(table)})'`。  
  - 修复（安全层）：限制 PRAGMA、ATTACH，关闭 `isolation_level=None`，只读权限。  
  - 验证：针对恶意表名 fuzz，确认报错且无数据泄露。  
  - 标准映射：CWE-89 / OWASP A03 Injection  
  - 追问：SQLite 文件权限是否可写？部署容器是否共享主机文件系统？

### 7) 数据建模
- **无显著发现**

### 8) 依赖与耦合
- **无显著发现**（psutil 新增风险低；未见新第三方不可信源）

### 9) 配置与变体
- **F6 文档端口与默认配置不一致**  
  - 规范严重级别：S1｜安全严重级别：Low｜置信度：高  
  - 位置：文档声明 8089；`config.py:18-21` 默认 8088；`start.sh` 读取同默认 8088。  
  - 偏离：运行环境不同端口即表现分裂，易部署失败/绕过预期监听。  
  - 修复：统一默认值并在 README/环境变量示例明确。  
  - 验证：CI 启动脚本读取 .env 后端口一致。

- **F2 CORS 允许任意来源且携带凭证**  
  - 规范严重级别：S2｜安全严重级别：High｜置信度：高  
  - 位置：`app.py:26-33` `allow_origins=["*"]` + `allow_credentials=True`。  
  - 攻击路径：若未来加 Cookie / Authorization 认证，浏览器可被任意站点发起携带凭证的跨站请求，导致 CSRF/数据泄露。  
  - 修复：收敛为受信域白名单；若需公开，设 `allow_credentials=False` 并仅返回公开数据。  
  - 验证：浏览器发起带 Cookie 的跨域请求应被阻断。  
  - 标准映射：CWE-346（不安全的信任边界）/ OWASP A01-Broken Access Control

### 10) 结构与架构
- **F1 缺失鉴权与访问控制**  
  - 规范严重级别：S3｜安全严重级别：High｜置信度：高  
  - 位置：`app.py:35-43` 注册所有路由时未添加任何依赖/中间件；全局无鉴权逻辑。  
  - 偏离：数据服务无“唯一权限语义”，任何来源可读内部指标库。  
  - 攻击路径：匿名请求读取市场数据与冷却表，结合 SQL 注入可横向获取更多信息。  
  - 修复：最小可行方案：全局依赖 API Key / JWT / 网关签名；对敏感 DB 读操作添加角色检查。  
  - 验证：未授权请求返回 401/403；授权后正常。  
  - 标准映射：CWE-284 / OWASP A01 Broken Access Control  
  - 追问：目标使用者是谁？是否已有反向代理或 WAF？

### 11) 性能与资源
- **见 F5**（连接泄漏可能导致资源耗尽）

### 12) 可观测性与运维
- **无显著发现**（未见日志注入风险；但缺少访问日志/指标收集，可在中长期治理中补充）。

## 5. 方向变量冲突与不可满足性分析
- 方向变量缺失，无法分析冲突。

## 6. 不可判定点与最坏情况推断
- 部署拓扑未提供：假设公网暴露，按最坏情况评估为高风险。
- DB 权限未知：假设进程用户可写 SQLite/可读 Timescale 全库，注入可能扩大为本地文件读取。
- 无速率限制：假设未启用外层限流，DoS 风险按最坏情况计算。

## 7. 回归风险与安全测试计划
- 回归风险：路由重命名可能破坏现有调用；端口差异导致部署脚本失效；新增依赖 psutil 需在镜像安装。
- 必测用例：
  - 未授权访问所有端点应被拒绝（在修复后）。
  - CORS：跨站带 Cookie 请求应被浏览器阻断。
  - SQL 注入：恶意表名/符号输入不应读取到系统表。
  - 参数语义：不同 interval/exchange 返回数据应变化。
  - 连接异常恢复：断开 DB 后服务应快速失败并释放资源。
- 自动化与监控：在 CI 加 SAST (bandit/sqlfluff)、在运行时加 Prometheus 连接数指标与 5xx 告警。

## 8. 依赖、配置与基础设施审计
- 依赖：新增 psutil（低风险）；其余依赖稳定。未见锁定版本对比。
- 配置：默认端口 8088 与文档不符；CORS 过宽；未见 API Key/Rate Limit。
- IaC/CI：未提供，无法审计；按最坏情况假设无镜像扫描与密钥管理。

## 9. 需要补充的信息清单
- P0：实际暴露网络范围与上游鉴权/网关配置；TimescaleDB 账号权限。
- P1：是否存在多周期/多交易所数据表映射规则；公开接口的目标用户列表。
- P2：日志与监控基线（是否采集 SQL 错误、连接数）。

## 10. 行动项
ID | 发现标题 | 负责人角色 | 优先级 | 建议类型 | 预计工作量
- | - | - | - | - | -
A1 | 为所有端点加鉴权/签名 | 后端 | P0 | 安全修复 | M
A2 | 收敛 CORS，移除 `*+credentials` | 后端 | P0 | 安全修复 | S
A3 | 修复 /indicator/data SQL 注入（白名单/参数化） | 后端 | P0 | 安全修复 | S
A4 | 使 interval/exchange 生效或删除参数并更新文档 | 后端 | P1 | 规范收敛 | M
A5 | 统一端口默认值与文档 | 运维 | P1 | 规范收敛 | S
A6 | 为 DB 访问加上下文管理/连接池 | 后端 | P1 | 安全修复 | M

## 11. 总结与长期建议
- 重复反模式：缺失访问控制、字符串拼接 SQL、配置与文档不一致。
- 长期建议：
  - 引入统一鉴权组件（API Key/JWT + 中间件），在网关层做限流与 IP 白名单。
  - 建立数据库访问基线：只读账号、必用参数化、统一连接池。
  - 在 CI 集成 SAST（bandit）与依赖漏洞扫描；新增 API 需同步安全评审与文档校验。
  - 规定 CORS 策略模板：默认关闭，按域名白名单开启。
